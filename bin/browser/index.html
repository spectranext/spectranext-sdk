<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPX Browser - Spectranext RAMFS</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/file-explorer.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        .footer {
            background-color: #2c3e50;
            color: white;
            padding: 8px 20px;
            font-size: 13px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        .footer a {
            color: #4CAF50;
            text-decoration: none;
            margin-left: 5px;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        #fileexplorer {
            flex: 1;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 0;
        }
        .footer {
            background-color: #2c3e50;
            color: white;
            padding: 8px 20px;
            font-size: 13px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        .footer a {
            color: #4CAF50;
            text-decoration: none;
            margin-left: 5px;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        /* Text file viewer modal */
        .text-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            overflow: auto;
        }
        .text-viewer-modal.active {
            display: flex;
            flex-direction: column;
        }
        .text-viewer-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            min-width: 600px;
        }
        .text-viewer-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f8f8;
            border-radius: 8px 8px 0 0;
        }
        .text-viewer-header h2 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        .text-viewer-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
        }
        .text-viewer-close:hover {
            color: #000;
        }
        .text-viewer-body {
            padding: 20px;
            overflow: auto;
            flex: 1;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #fff;
        }
    </style>
</head>
<body>
    <div id="fileexplorer"></div>
    
    <!-- Text file viewer modal -->
    <div id="text-viewer-modal" class="text-viewer-modal">
        <div class="text-viewer-content">
            <div class="text-viewer-header">
                <h2 id="text-viewer-title">File Viewer</h2>
                <button class="text-viewer-close" onclick="closeTextViewer()">&times;</button>
            </div>
            <div class="text-viewer-body" id="text-viewer-body"></div>
        </div>
    </div>

    <script src="/static/file-explorer.js"></script>
    <script>
        (function() {
            var elem = document.getElementById('fileexplorer');
            
            // Helper function to convert folder path IDs to API path
            function getApiPath(pathIds) {
                if (!pathIds || pathIds.length === 0) {
                    return '';
                }
                // Filter out empty strings (like root path '')
                var filtered = pathIds.filter(function(id) { return id !== '' && id !== null && id !== undefined; });
                if (filtered.length === 0) {
                    return '';
                }
                // Join path IDs and ensure no leading slash
                var path = filtered.join('/');
                return path.replace(/^\//, '');
            }
            
            // Check if a file is a text file based on extension
            function isTextFile(filename) {
                if (!filename) return false;
                var textExtensions = ['.txt', '.bas', '.asm', '.c', '.h', '.cpp', '.hpp', '.py', '.js', '.html', '.css', '.json', '.xml', '.md', '.log', '.conf', '.cfg', '.ini', '.sh', '.bat', '.cmd', '.ps1', '.yml', '.yaml', '.toml', '.csv', '.tsv'];
                var ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
                return textExtensions.indexOf(ext) !== -1;
            }
            
            // Open text file viewer
            function openTextViewer(folder, filename) {
                var pathIds = folder.GetPathIDs();
                pathIds.push(filename);
                var apiPath = getApiPath(pathIds);
                var url = '/download/' + encodeURIComponent(apiPath);
                
                document.getElementById('text-viewer-title').textContent = filename;
                document.getElementById('text-viewer-body').textContent = 'Loading...';
                document.getElementById('text-viewer-modal').classList.add('active');
                
                fetch(url)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status);
                        }
                        return response.text();
                    })
                    .then(function(text) {
                        document.getElementById('text-viewer-body').textContent = text;
                    })
                    .catch(function(error) {
                        document.getElementById('text-viewer-body').textContent = 'Error loading file: ' + error.message;
                    });
            }
            
            // Close text file viewer
            function closeTextViewer() {
                document.getElementById('text-viewer-modal').classList.remove('active');
                document.getElementById('text-viewer-body').textContent = '';
            }
            
            // Close modal when clicking outside
            document.getElementById('text-viewer-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTextViewer();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeTextViewer();
                }
            });
            
            // Initialize FileExplorer
            var fe = new FileExplorer(elem, {
                'initpath': [['', 'RAMFS (/)']],
                'tools': {
                    'item_checkboxes': true
                },
                'onrefresh': function(folder, required) {
                    // Get folder path IDs
                    var pathIds = folder.GetPathIDs();
                    var apiPath = getApiPath(pathIds);
                    var url = '/ramfs/' + encodeURIComponent(apiPath);
                    
                    fetch(url)
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('HTTP ' + response.status);
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            // Convert API response to FileExplorer format
                            var entries = [];
                            for (var i = 0; i < data.entries.length; i++) {
                                var entry = data.entries[i];
                                var feEntry = {
                                    'name': entry.name,
                                    'type': entry.type === 'folder' ? 'folder' : 'file',
                                    'id': entry.name,
                                    'hash': entry.name
                                };
                                if (entry.size) {
                                    feEntry.size = entry.size;
                                }
                                entries.push(feEntry);
                            }
                            if (fe.IsMappedFolder(folder)) {
                                folder.SetEntries(entries);
                            }
                        })
                        .catch(function(error) {
                            console.error('Error loading folder:', error);
                        });
                },
                'oninitdownload': function(startdownload, folder, ids, entries) {
                    // Handle downloads - download selected files
                    if (entries.length === 0) {
                        return;
                    }
                    
                    // For single file download
                    if (entries.length === 1) {
                        var pathIds = folder.GetPathIDs();
                        pathIds.push(entries[0].name);
                        var apiPath = getApiPath(pathIds);
                        var options = {
                            url: '/download/' + encodeURIComponent(apiPath),
                            method: 'GET'
                        };
                        startdownload(options);
                    } else {
                        // For multiple files, download them one by one
                        // Start with the first file
                        var pathIds = folder.GetPathIDs();
                        pathIds.push(entries[0].name);
                        var apiPath = getApiPath(pathIds);
                        var options = {
                            url: '/download/' + encodeURIComponent(apiPath),
                            method: 'GET'
                        };
                        startdownload(options);
                    }
                },
                'ondownloadurl': function(result, folder, ids, entry) {
                    // Return download URL for single file (used by some download methods)
                    var pathIds = folder.GetPathIDs();
                    pathIds.push(entry.name);
                    var apiPath = getApiPath(pathIds);
                    result('/download/' + encodeURIComponent(apiPath));
                },
                'oninitupload': function(startupload, fileinfo) {
                    // Get the name/id from fileinfo - it might be in different properties
                    // fileinfo.fullPath contains the full path like '/M5.stl'
                    var fileName = fileinfo.name || fileinfo.id || fileinfo.filename;
                    
                    // If fileName is not available, extract from fullPath
                    if (!fileName && fileinfo.fullPath) {
                        // Extract filename from fullPath (e.g., '/M5.stl' -> 'M5.stl')
                        var pathParts = fileinfo.fullPath.split('/').filter(function(part) {
                            return part !== '';
                        });
                        fileName = pathParts[pathParts.length - 1];
                    }
                    
                    if (!fileName) {
                        console.error('Cannot upload: file name is undefined', fileinfo);
                        startupload(false);
                        return;
                    }
                    
                    if (fileinfo.type === 'dir') {
                        // Create directory
                        var pathIds = fileinfo.folder.GetPathIDs();
                        pathIds.push(fileName);
                        var apiPath = getApiPath(pathIds);
                        
                        // Ensure apiPath includes the directory name
                        if (!apiPath || apiPath === '') {
                            apiPath = fileName;
                        }
                        
                        var url = '/mkdir/' + encodeURIComponent(apiPath);
                        
                        fetch(url, {
                            method: 'POST'
                        })
                            .then(function(response) {
                                if (!response.ok) {
                                    return response.json().then(function(data) {
                                        throw new Error(data.detail || 'Create directory failed');
                                    });
                                }
                                startupload(false); // Remove from queue
                            })
                            .catch(function(error) {
                                console.error('Error creating directory:', error);
                                startupload(false);
                            });
                    } else {
                        // Upload file - ensure filename is included in path
                        var pathIds = fileinfo.folder.GetPathIDs();
                        // Add filename to path
                        pathIds.push(fileName);
                        var apiPath = getApiPath(pathIds);
                        
                        // Ensure apiPath includes the filename
                        if (!apiPath || apiPath === '') {
                            apiPath = fileName;
                        }
                        
                        fileinfo.url = '/ramfs/' + encodeURIComponent(apiPath);
                        fileinfo.method = 'POST';
                        fileinfo.fileparam = 'file';
                        
                        startupload(true);
                    }
                },
                'ondelete': function(deleted, folder, entry) {
                    // Delete file or folder - handle single or multiple entries
                    // entry might be a string (single or comma-separated), an array, or an object
                    var entryNames = [];
                    
                    if (Array.isArray(entry)) {
                        // Multiple entries as array
                        entryNames = entry.map(function(item) {
                            if (typeof item === 'string') {
                                return item.trim();
                            } else if (item && typeof item === 'object') {
                                return (item.name || item.id || '').trim();
                            }
                            return '';
                        }).filter(function(name) {
                            return name !== '';
                        });
                    } else if (typeof entry === 'string') {
                        // Check if it's comma-separated (multiple entries)
                        if (entry.indexOf(',') !== -1) {
                            entryNames = entry.split(',').map(function(name) {
                                return name.trim();
                            }).filter(function(name) {
                                return name !== '';
                            });
                        } else {
                            entryNames = [entry.trim()];
                        }
                    } else if (entry && typeof entry === 'object') {
                        // Single entry object
                        var entryName = entry.name || entry.id;
                        if (entryName) {
                            entryNames = [entryName];
                        }
                    }
                    
                    if (entryNames.length === 0) {
                        console.error('Cannot delete: entry name is undefined', entry);
                        deleted();
                        return;
                    }
                    
                    // Delete each entry sequentially
                    var deletePromises = entryNames.map(function(entryName) {
                        var pathIds = folder.GetPathIDs();
                        // Add entry name to path
                        pathIds.push(entryName);
                        var apiPath = getApiPath(pathIds);
                        
                        // Ensure apiPath includes the entry name
                        if (!apiPath || apiPath === '') {
                            apiPath = entryName;
                        }
                        
                        var url = '/ramfs/' + encodeURIComponent(apiPath);
                        
                        return fetch(url, {
                            method: 'DELETE'
                        }).then(function(response) {
                            if (!response.ok) {
                                return response.json().then(function(data) {
                                    var errorMsg = 'Failed to delete ' + entryName + ': ' + (data.detail || 'Delete failed');
                                    console.warn(errorMsg);
                                    // Don't throw - continue with other deletions
                                    return { success: false, name: entryName, error: errorMsg };
                                }).catch(function() {
                                    var errorMsg = 'Failed to delete ' + entryName + ' (HTTP ' + response.status + ')';
                                    console.warn(errorMsg);
                                    return { success: false, name: entryName, error: errorMsg };
                                });
                            }
                            return { success: true, name: entryName };
                        }).catch(function(error) {
                            console.warn('Error deleting ' + entryName + ':', error);
                            return { success: false, name: entryName, error: error.message || 'Unknown error' };
                        });
                    });
                    
                    // Wait for all deletions to complete
                    Promise.all(deletePromises)
                        .then(function(results) {
                            // Check if any deletions failed
                            var failures = results.filter(function(r) { return !r.success; });
                            if (failures.length > 0) {
                                var failedNames = failures.map(function(f) { return f.name; }).join(', ');
                                console.warn('Some items failed to delete:', failedNames);
                                // Still refresh to show current state
                            }
                            // Always call deleted() to refresh the folder
                            deleted();
                        })
                        .catch(function(error) {
                            console.error('Unexpected error during deletion:', error);
                            // Still call deleted() to refresh
                            deleted();
                        });
                },
                'onnewfolder': function(created, folder) {
                    // Prompt user for directory name
                    var folderName = prompt('Enter the name for the new folder:');
                    
                    // Check if user provided a name
                    if (!folderName || folderName.trim() === '') {
                        // User canceled or provided empty name
                        created(false);
                        return;
                    }
                    
                    folderName = folderName.trim();
                    
                    // Create new folder
                    var pathIds = folder.GetPathIDs();
                    pathIds.push(folderName);
                    var apiPath = getApiPath(pathIds);
                    
                    // Ensure apiPath includes the directory name
                    if (!apiPath || apiPath === '') {
                        apiPath = folderName;
                    }
                    
                    var url = '/mkdir/' + encodeURIComponent(apiPath);
                    
                    fetch(url, {
                        method: 'POST'
                    })
                        .then(function(response) {
                            if (!response.ok) {
                                return response.json().then(function(data) {
                                    var errorMsg = typeof data.detail === 'string' ? data.detail : 'Create directory failed';
                                    throw new Error(errorMsg);
                                }).catch(function() {
                                    throw new Error('Create directory failed (HTTP ' + response.status + ')');
                                });
                            }
                            // Success - parse JSON response
                            return response.json().catch(function() {
                                // If JSON parsing fails, that's OK - response was successful
                                return {};
                            });
                        })
                        .then(function(data) {
                            // Call created(true) to signal success
                            created(true);
                            // Refresh the current folder to show the new directory
                            // Trigger a refresh by calling onrefresh callback
                            if (fe.IsMappedFolder(folder)) {
                                // Get the onrefresh callback and call it
                                var pathIds = folder.GetPathIDs();
                                var apiPath = getApiPath(pathIds);
                                var url = '/ramfs/' + encodeURIComponent(apiPath);
                                
                                fetch(url)
                                    .then(function(response) {
                                        if (!response.ok) {
                                            throw new Error('HTTP ' + response.status);
                                        }
                                        return response.json();
                                    })
                                    .then(function(data) {
                                        // Convert API response to FileExplorer format
                                        var entries = [];
                                        for (var i = 0; i < data.entries.length; i++) {
                                            var entry = data.entries[i];
                                            var feEntry = {
                                                'name': entry.name,
                                                'type': entry.type === 'folder' ? 'folder' : 'file',
                                                'id': entry.name,
                                                'hash': entry.name
                                            };
                                            if (entry.size) {
                                                feEntry.size = entry.size;
                                            }
                                            entries.push(feEntry);
                                        }
                                        if (fe.IsMappedFolder(folder)) {
                                            folder.SetEntries(entries);
                                        }
                                    })
                                    .catch(function(error) {
                                        console.error('Error refreshing folder:', error);
                                    });
                            }
                        })
                        .catch(function(error) {
                            console.error('Error creating directory:', error);
                            var errorMsg = error.message || 'Unknown error';
                            alert('Error creating directory: ' + errorMsg);
                            // Call created(false) to signal failure
                            created(false);
                        });
                }
            });
        })();
    </script>
    <div class="footer">
        <span>Spectranext Documentation:</span>
        <a href="https://docs.spectranext.net" target="_blank" rel="noopener noreferrer">docs.spectranext.net</a>
    </div>
</body>
</html>

